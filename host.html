<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jukebox Host</title>
    <style>
        body { font-family: sans-serif; background-color: #222; color: white; padding: 20px; text-align: center; }
        
        #player-container { border: 2px solid #444; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #1DB954; border: none; color: white; border-radius: 5px; margin: 5px; }
        
        /* UNLOCK BUTTON STYLE */
        #unlock-btn { background: #0000ff; color: white; font-size: 20px; padding: 20px; width: 100%; margin-bottom: 20px; border: 2px solid white; display: block; }
        
        .queue-item { background: #444; margin: 5px 0; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
    </style>
</head>
<body>

    <button id="unlock-btn" onclick="unlockAudio()">üîä CLICK HERE TO START SESSION</button>

    <h1>Jukebox Host</h1>

    <div id="player-container">
        <div id="now-playing-text" style="font-size: 20px; margin-bottom:10px;">Waiting...</div>
        <audio id="audio-player" controls style="width: 100%;"></audio>
        <br><br>
        <button onclick="playNext()">‚ñ∂ Play Next</button>
        <button onclick="skipSong()">‚è≠ Skip</button>
    </div>

    <h3>Up Next</h3>
    <div id="queue-list"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const audioPlayer = document.getElementById('audio-player');
        const queueList = document.getElementById('queue-list');
        const nowPlayingText = document.getElementById('now-playing-text');
        
        let queue = [];
        let isAudioUnlocked = false;

        function unlockAudio() {
            // Play silent audio to unlock browser
            audioPlayer.play().catch(e => console.log("Silent unlock"));
            isAudioUnlocked = true;
            document.getElementById('unlock-btn').style.display = 'none';
        }

        socket.on('updateQueue', (newQueue) => {
            queue = newQueue;
            renderQueue();
            
            // If we have songs and audio is unlocked, try to play
            if (isAudioUnlocked && audioPlayer.paused && queue.length > 0) {
               playNext(); // Auto-play attempt
            }
        });

        function playNext() {
            if (queue.length === 0) {
                nowPlayingText.innerText = "Queue is empty";
                return;
            }
            const nextSong = queue.shift(); 
            socket.emit('syncQueue', queue);

            nowPlayingText.innerText = `Now Playing: ${nextSong.title}`;
            audioPlayer.src = nextSong.url;
            
            audioPlayer.play().catch(e => {
                console.error("Play failed:", e);
                alert("Please click the 'Play Next' button manually.");
            });
        }

        function skipSong() {
            audioPlayer.pause();
            playNext();
        }

        function removeSong(index) {
            queue.splice(index, 1);
            socket.emit('syncQueue', queue);
            renderQueue();
        }

        function renderQueue() {
            queueList.innerHTML = "";
            queue.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = "queue-item";
                div.innerHTML = `
                    <span>${index + 1}. ${song.title} <small>(${song.requester})</small></span>
                    <button style="background:#d32f2f" onclick="removeSong(${index})">X</button>
                `;
                queueList.appendChild(div);
            });
        }

        audioPlayer.onended = function() { playNext(); };
    </script>
</body>
</html>
